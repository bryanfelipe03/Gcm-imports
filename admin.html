<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Gcm-imports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .table-container {
            overflow-x: auto;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        #image-preview {
            max-width: 100%;
            max-height: 200px;
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header, Main, Modals mantidos iguais -->
    <script>
        // Configuração do Supabase
        const supabaseUrl = 'https://rtpxtxqkymqsstmtclwz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0cHh0eHFreW1xc3N0bXRjbHd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NjYxMDksImV4cCI6MjA2MjI0MjEwOX0.seEDFpblmWB6EXSjDq20AfoTvt_siZ-tVfmgDPqKTlY';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // DOM Elements (mantidos iguais)
        const productsTable = document.getElementById('products-table');
        const ordersTable = document.getElementById('orders-table');
        const addProductBtn = document.getElementById('add-product-btn');
        const productModal = document.getElementById('product-modal');
        const productModalTitle = document.getElementById('product-modal-title');
        const closeProductModal = document.getElementById('close-product-modal');
        const productForm = document.getElementById('product-form');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productCategoryInput = document.getElementById('product-category');
        const productPriceInput = document.getElementById('product-price');
        const productImageInput = document.getElementById('product-image');
        const imagePreview = document.getElementById('image-preview');
        const productDescriptionInput = document.getElementById('product-description');
        const productPopularInput = document.getElementById('product-popular');
        const logoutBtn = document.getElementById('logout-btn');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        const categoriesModal = document.getElementById('categories-modal');
        const closeCategoriesModal = document.getElementById('close-categories-modal');
        const categoryForm = document.getElementById('category-form');
        const categoryNameInput = document.getElementById('category-name');
        const categorySlugInput = document.getElementById('category-slug');
        const categoriesTable = document.getElementById('categories-table');

        // Verificar autenticação
        async function checkAuth() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                alert('Você precisa estar logado para acessar o painel.');
                window.location.href = '/index.html';
            }
        }

        // Buscar categorias, produtos, pedidos (mantidos iguais)
        async function fetchCategories() {
            const { data, error } = await supabaseClient.from('categories').select('*');
            if (error) {
                console.error('Erro ao buscar categorias:', error);
                return [];
            }
            return data;
        }

        async function fetchProducts() {
            const { data, error } = await supabaseClient.from('products').select('*');
            if (error) {
                console.error('Erro ao buscar produtos:', error);
                return [];
            }
            return data;
        }

        async function fetchOrders() {
            const { data, error } = await supabaseClient.from('orders').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error('Erro ao buscar pedidos:', error);
                return [];
            }
            return data;
        }

        async function loadCategoriesSelect() {
            const categories = await fetchCategories();
            productCategoryInput.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.slug;
                option.textContent = category.name;
                productCategoryInput.appendChild(option);
            });
        }

        async function renderCategories() {
            const categories = await fetchCategories();
            categoriesTable.innerHTML = '';
            categories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${category.name}</td>
                    <td class="py-3 px-4">${category.slug}</td>
                    <td class="py-3 px-4">
                        <button class="delete-category text-red-500 hover:text-red-700" data-id="${category.id}" data-slug="${category.slug}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                categoriesTable.appendChild(row);
            });

            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', () => deleteCategory(btn.dataset.id, btn.dataset.slug));
            });
        }

        async function renderProducts() {
            const products = await fetchProducts();
            productsTable.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${product.id}</td>
                    <td class="py-3 px-4">${product.name}</td>
                    <td class="py-3 px-4">${product.category}</td>
                    <td class="py-3 px-4">${product.price.toFixed(2)}</td>
                    <td class="py-3 px-4"><a href="${product.image}" target="_blank">Ver</a></td>
                    <td class="py-3 px-4">${product.description || 'Sem descrição'}</td>
                    <td class="py-3 px-4">${product.popular}</td>
                    <td class="py-3 px-4">
                        <button class="edit-product text-blue-500 hover:text-blue-700 mr-2" data-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-product text-red-500 hover:text-red-700" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                productsTable.appendChild(row);
            });

            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', () => editProduct(btn.dataset.id));
            });
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
            });
        }

        async function renderOrders() {
            const orders = await fetchOrders();
            ordersTable.innerHTML = '';
            orders.forEach(order => {
                const items = JSON.parse(order.items);
                const itemsList = items.map(item => `${item.name} (${item.quantity}x)`).join(', ');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${order.id}</td>
                    <td class="py-3 px-4">${order.client_name}</td>
                    <td class="py-3 px-4">${order.client_address}</td>
                    <td class="py-3 px-4">${order.payment_method}</td>
                    <td class="py-3 px-4">${order.total.toFixed(2)}</td>
                    <td class="py-3 px-4">${new Date(order.created_at).toLocaleString('pt-BR')}</td>
                    <td class="py-3 px-4">${itemsList}</td>
                `;
                ordersTable.appendChild(row);
            });
        }

        productImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                imagePreview.src = '';
            }
        });

        // Adicionar/editar produto com upload corrigido
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = productIdInput.value;
            let imageUrl = '';

            const file = productImageInput.files[0];
            if (file) {
                const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`; // Sanitizar nome do arquivo
                const { data, error } = await supabaseClient
                    .storage
                    .from('product-images')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error('Erro ao fazer upload da imagem:', error);
                    alert('Erro ao fazer upload da imagem. Verifique o console para detalhes.');
                    return;
                }

                // Obter URL pública com verificação
                const { data: publicUrlData } = supabaseClient
                    .storage
                    .from('product-images')
                    .getPublicUrl(fileName);

                if (!publicUrlData || !publicUrlData.publicUrl) {
                    console.error('Erro ao obter URL pública da imagem');
                    alert('Erro ao obter URL pública da imagem.');
                    return;
                }

                imageUrl = publicUrlData.publicUrl;
                console.log('URL da imagem:', imageUrl); // Log para depuração
            } else if (id) {
                const { data: existingProduct } = await supabaseClient
                    .from('products')
                    .select('image')
                    .eq('id', id)
                    .single();
                imageUrl = existingProduct.image || '';
            } else {
                alert('Por favor, selecione uma imagem para o produto.');
                return;
            }

            const product = {
                name: productNameInput.value,
                category: productCategoryInput.value,
                price: parseFloat(productPriceInput.value),
                image: imageUrl,
                description: productDescriptionInput.value,
                popular: parseInt(productPopularInput.value)
            };

            if (id) {
                const { error } = await supabaseClient
                    .from('products')
                    .update(product)
                    .eq('id', id);
                if (error) {
                    console.error('Erro ao editar produto:', error);
                    alert('Erro ao editar produto.');
                    return;
                }
            } else {
                const { error } = await supabaseClient
                    .from('products')
                    .insert(product);
                if (error) {
                    console.error('Erro ao adicionar produto:', error);
                    alert('Erro ao adicionar produto.');
                    return;
                }
            }

            productModal.classList.add('hidden');
            productForm.reset();
            productIdInput.value = '';
            imagePreview.style.display = 'none';
            productModalTitle.textContent = 'Adicionar Produto';
            renderProducts();
        });

        async function editProduct(id) {
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .eq('id', id)
                .single();
            if (error) {
                console.error('Erro ao buscar produto:', error);
                return;
            }
            productIdInput.value = data.id;
            productNameInput.value = data.name;
            productCategoryInput.value = data.category;
            productPriceInput.value = data.price;
            productImageInput.value = '';
            imagePreview.src = data.image;
            imagePreview.style.display = data.image ? 'block' : 'none';
            productDescriptionInput.value = data.description || '';
            productPopularInput.value = data.popular;
            productModalTitle.textContent = 'Editar Produto';
            productModal.classList.remove('hidden');
        }

        async function deleteProduct(id) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            const { data: product } = await supabaseClient
                .from('products')
                .select('image')
                .eq('id', id)
                .single();
            if (product.image) {
                const fileName = product.image.split('/').pop();
                await supabaseClient.storage.from('product-images').remove([fileName]);
            }

            const { error } = await supabaseClient
                .from('products')
                .delete()
                .eq('id', id);
            if (error) {
                console.error('Erro ao excluir produto:', error);
                alert('Erro ao excluir produto.');
                return;
            }
            renderProducts();
        }

        async function deleteCategory(id, slug) {
            const { data: products } = await supabaseClient
                .from('products')
                .select('id')
                .eq('category', slug);

            if (products && products.length > 0) {
                alert('Não é possível excluir esta categoria, pois há produtos associados a ela.');
                return;
            }

            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;

            const { error } = await supabaseClient
                .from('categories')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Erro ao excluir categoria:', error);
                alert('Erro ao excluir categoria.');
                return;
            }

            renderCategories();
            loadCategoriesSelect();
        }

        addProductBtn.addEventListener('click', () => {
            productForm.reset();
            productIdInput.value = '';
            imagePreview.style.display = 'none';
            productModalTitle.textContent = 'Adicionar Produto';
            productModal.classList.remove('hidden');
        });

        closeProductModal.addEventListener('click', () => {
            productModal.classList.add('hidden');
        });

        manageCategoriesBtn.addEventListener('click', () => {
            renderCategories();
            categoriesModal.classList.remove('hidden');
        });

        closeCategoriesModal.addEventListener('click', () => {
            categoriesModal.classList.add('hidden');
        });

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = categoryNameInput.value.trim();
            const slug = categorySlugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');

            if (!name || !slug) {
                alert('Por favor, preencha nome e slug da categoria.');
                return;
            }

            const { error } = await supabaseClient
                .from('categories')
                .insert({ name, slug });

            if (error) {
                console.error('Erro ao adicionar categoria:', error);
                alert('Erro ao adicionar categoria. Verifique se o slug é único.');
                return;
            }

            categoryForm.reset();
            renderCategories();
            loadCategoriesSelect();
        });

        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = '/index.html';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadCategoriesSelect();
            await renderProducts();
            await renderOrders();
        });
    </script>
</body>
</html>
